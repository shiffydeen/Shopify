{
  "version": 3,
  "sources": ["../../cli-kit/src/public/node/session.ts"],
  "sourcesContent": ["import {normalizeStoreFqdn} from './context/fqdn.js'\nimport {BugError} from './error.js'\nimport {getPartnersToken} from './environment.js'\nimport {nonRandomUUID} from './crypto.js'\nimport * as secureStore from '../../private/node/session/store.js'\nimport {\n  exchangeCustomPartnerToken,\n  exchangeCliTokenForAppManagementAccessToken,\n  exchangeCliTokenForBusinessPlatformAccessToken,\n} from '../../private/node/session/exchange.js'\nimport {outputContent, outputToken, outputDebug} from '../../public/node/output.js'\nimport {\n  AdminAPIScope,\n  AppManagementAPIScope,\n  BusinessPlatformScope,\n  PartnersAPIScope,\n  StorefrontRendererScope,\n  ensureAuthenticated,\n  setLastSeenAuthMethod,\n  setLastSeenUserIdAfterAuth,\n} from '../../private/node/session.js'\nimport {isThemeAccessSession} from '../../private/node/api/rest.js'\n\n/**\n * Session Object to access the Admin API, includes the token and the store FQDN.\n */\nexport interface AdminSession {\n  token: string\n  storeFqdn: string\n}\n\ninterface EnsureAuthenticatedAdditionalOptions {\n  noPrompt?: boolean\n  forceRefresh?: boolean\n}\n\n/**\n * Ensure that we have a valid session to access the Partners API.\n * If SHOPIFY_CLI_PARTNERS_TOKEN exists, that token will be used to obtain a valid Partners Token\n * If SHOPIFY_CLI_PARTNERS_TOKEN exists, scopes will be ignored.\n *\n * @param scopes - Optional array of extra scopes to authenticate with.\n * @param env - Optional environment variables to use.\n * @param options - Optional extra options to use.\n * @returns The access token for the Partners API.\n */\nexport async function ensureAuthenticatedPartners(\n  scopes: PartnersAPIScope[] = [],\n  env = process.env,\n  options: EnsureAuthenticatedAdditionalOptions = {},\n): Promise<{token: string; userId: string}> {\n  outputDebug(outputContent`Ensuring that the user is authenticated with the Partners API with the following scopes:\n${outputToken.json(scopes)}\n`)\n  const envToken = getPartnersToken()\n  if (envToken) {\n    const result = await exchangeCustomPartnerToken(envToken)\n    return {token: result.accessToken, userId: result.userId}\n  }\n  const tokens = await ensureAuthenticated({partnersApi: {scopes}}, env, options)\n  if (!tokens.partners) {\n    throw new BugError('No partners token found after ensuring authenticated')\n  }\n  return {token: tokens.partners, userId: tokens.userId}\n}\n\n/**\n * Ensure that we have a valid session to access the App Management API.\n *\n * @param options - Optional extra options to use.\n * @param appManagementScopes - Optional array of extra scopes to authenticate with.\n * @param businessPlatformScopes - Optional array of extra scopes to authenticate with.\n * @param env - Optional environment variables to use.\n * @returns The access token for the App Management API.\n */\nexport async function ensureAuthenticatedAppManagementAndBusinessPlatform(\n  options: EnsureAuthenticatedAdditionalOptions = {},\n  appManagementScopes: AppManagementAPIScope[] = [],\n  businessPlatformScopes: BusinessPlatformScope[] = [],\n  env = process.env,\n): Promise<{appManagementToken: string; userId: string; businessPlatformToken: string}> {\n  outputDebug(outputContent`Ensuring that the user is authenticated with the App Management API with the following scopes:\n${outputToken.json(appManagementScopes)}\n`)\n\n  const envToken = getPartnersToken()\n  if (envToken) {\n    const appManagmentToken = await exchangeCliTokenForAppManagementAccessToken(envToken)\n    const businessPlatformToken = await exchangeCliTokenForBusinessPlatformAccessToken(envToken)\n\n    return {\n      appManagementToken: appManagmentToken.accessToken,\n      userId: appManagmentToken.userId,\n      businessPlatformToken: businessPlatformToken.accessToken,\n    }\n  }\n\n  const tokens = await ensureAuthenticated(\n    {appManagementApi: {scopes: appManagementScopes}, businessPlatformApi: {scopes: businessPlatformScopes}},\n    env,\n    options,\n  )\n  if (!tokens.appManagement || !tokens.businessPlatform) {\n    throw new BugError('No App Management or Business Platform token found after ensuring authenticated')\n  }\n\n  return {\n    appManagementToken: tokens.appManagement,\n    userId: tokens.userId,\n    businessPlatformToken: tokens.businessPlatform,\n  }\n}\n\n/**\n * Ensure that we have a valid session to access the Storefront API.\n *\n * @param scopes - Optional array of extra scopes to authenticate with.\n * @param password - Optional password to use.\n * @param forceRefresh - Optional flag to force a refresh of the token.\n * @returns The access token for the Storefront API.\n */\nexport async function ensureAuthenticatedStorefront(\n  scopes: StorefrontRendererScope[] = [],\n  password: string | undefined = undefined,\n  forceRefresh = false,\n): Promise<string> {\n  if (password) {\n    const session = {token: password, storeFqdn: ''}\n    const authMethod = isThemeAccessSession(session) ? 'theme_access_token' : 'custom_app_token'\n    setLastSeenAuthMethod(authMethod)\n    setLastSeenUserIdAfterAuth(nonRandomUUID(password))\n    return password\n  }\n\n  outputDebug(outputContent`Ensuring that the user is authenticated with the Storefront API with the following scopes:\n${outputToken.json(scopes)}\n`)\n  const tokens = await ensureAuthenticated({storefrontRendererApi: {scopes}}, process.env, {forceRefresh})\n  if (!tokens.storefront) {\n    throw new BugError('No storefront token found after ensuring authenticated')\n  }\n  return tokens.storefront\n}\n\n/**\n * Ensure that we have a valid Admin session for the given store.\n *\n * @param store - Store fqdn to request auth for.\n * @param scopes - Optional array of extra scopes to authenticate with.\n * @param forceRefresh - Optional flag to force a refresh of the token.\n * @param options - Optional extra options to use.\n * @returns The access token for the Admin API.\n */\nexport async function ensureAuthenticatedAdmin(\n  store: string,\n  scopes: AdminAPIScope[] = [],\n  forceRefresh = false,\n  options: EnsureAuthenticatedAdditionalOptions = {},\n): Promise<AdminSession> {\n  outputDebug(outputContent`Ensuring that the user is authenticated with the Admin API with the following scopes for the store ${outputToken.raw(\n    store,\n  )}:\n${outputToken.json(scopes)}\n`)\n  const tokens = await ensureAuthenticated({adminApi: {scopes, storeFqdn: store}}, process.env, {\n    forceRefresh,\n    ...options,\n  })\n  if (!tokens.admin) {\n    throw new BugError('No admin token found after ensuring authenticated')\n  }\n  return tokens.admin\n}\n\n/**\n * Ensure that we have a valid session to access the Theme API.\n * If a password is provided, that token will be used against Theme Access API.\n * Otherwise, it will ensure that the user is authenticated with the Admin API.\n *\n * @param store - Store fqdn to request auth for.\n * @param password - Password generated from Theme Access app.\n * @param scopes - Optional array of extra scopes to authenticate with.\n * @param forceRefresh - Optional flag to force a refresh of the token.\n * @returns The access token and store.\n */\nexport async function ensureAuthenticatedThemes(\n  store: string,\n  password: string | undefined,\n  scopes: AdminAPIScope[] = [],\n  forceRefresh = false,\n): Promise<AdminSession> {\n  outputDebug(outputContent`Ensuring that the user is authenticated with the Theme API with the following scopes:\n${outputToken.json(scopes)}\n`)\n  if (password) {\n    const session = {token: password, storeFqdn: await normalizeStoreFqdn(store)}\n    const authMethod = isThemeAccessSession(session) ? 'theme_access_token' : 'custom_app_token'\n    setLastSeenAuthMethod(authMethod)\n    setLastSeenUserIdAfterAuth(nonRandomUUID(password))\n    return session\n  }\n  return ensureAuthenticatedAdmin(store, scopes, forceRefresh)\n}\n\n/**\n * Ensure that we have a valid session to access the Business Platform API.\n *\n * @param scopes - Optional array of extra scopes to authenticate with.\n * @returns The access token for the Business Platform API.\n */\nexport async function ensureAuthenticatedBusinessPlatform(scopes: BusinessPlatformScope[] = []): Promise<string> {\n  outputDebug(outputContent`Ensuring that the user is authenticated with the Business Platform API with the following scopes:\n${outputToken.json(scopes)}\n`)\n  const tokens = await ensureAuthenticated({businessPlatformApi: {scopes}}, process.env)\n  if (!tokens.businessPlatform) {\n    throw new BugError('No business-platform token found after ensuring authenticated')\n  }\n  return tokens.businessPlatform\n}\n\n/**\n * Logout from Shopify.\n *\n * @returns A promise that resolves when the logout is complete.\n */\nexport function logout(): Promise<void> {\n  return secureStore.remove()\n}\n"],
  "mappings": "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",
  "names": []
}
